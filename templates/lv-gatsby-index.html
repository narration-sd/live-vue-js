<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
    .lv-iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    .lv-frame-hidden {
        visibility: hidden;
        display: none;
        /*width: 0;*/
    }
    .lv-frame-show {
        visibility: visible;
        display: block;
        /*width: 100%;*/
    }
    .lv-content-hide {
        visibility: hidden;
        display: none;
        opacity: 0;
    }
    .lv-content-show {
        visibility: visible;
        display: block;
    }
    </style>

</head>
<body>
<noscript>
    <strong>We're sorry but Live Vue previews don't work properly without JavaScript
        enabled. Please enable it to continue.</strong>
</noscript>

<div id="content" class="lv-content-hide">
    <script>
    // console.log = function() {}

    // *todo* some choices here for now, before Settings routing
    var gatsbySite = "https://lv-gatsby.test/page-8"
    // var gatsbySite = "https://staging.narrationsd.com/page-7"

    // no non-https because browsers, and this one can only be used w/mitmproxy
    // var gatsbySite = "https://localhost/page-7"

    </script>
    {% hook "live-vue" %}
    <script>
    var iframeElem = document.createElement('iframe')
    iframeElem.src = gatsbySite + '?isLiveVue=1'
    iframeElem.id = 'ifrm'
    iframeElem.className = 'lv-iframe lv-frame-hidden'

    // *todo* any amount of these dataset tryouts can go
    iframeElem.name = 'live-vue-frame'
    iframeElem.dataset.iframeReady = 'no'
    iframeElem.dataset.isLiveVue = true

    document.body.appendChild(iframeElem)
    // *todo* out also all with contentElement - nothing touches, hence msgs
    var contentElement = document.getElementById('content')

    // for our postMessage from the iframe
    var iframeLoaded = 'no'
    function receiveMessage(event) {
      console.log('parent received message: ' + JSON.stringify(event.data))
      if (event.data === 'loaded') {
        iframeLoaded = 'loaded'
        console.log('parent got iframe loaded on data: ' + event.data)
        // document.getElementById('content').style.visibility = 'visible'
        // document.getElementById('content').style.opacity = 1
        // document.write('DO WE SEE THIS ANYWAY?')
      }
    }
    window.addEventListener('message', receiveMessage, false)
    </script>
    {#<iframe id="ifrm" name="live-vue" class="lv-iframe"#}
    {#        src="https://localhost/page-5"></iframe>#}
    {#<iframe id="ifrm" name="live-vue" class="lv-iframe" src="https://lv-gatsby.test/page-5"></iframe>#}
    {#<iframe id="ifrm" name="live-vue" class="lv-iframe" src="https://localhost/page-5"></iframe>#}
    {#<iframe id="ifrm" name="live-vue" class="lv-iframe" ></iframe>#}
    <script>
    // document.getElementById('ifrm').src = gatsbySite
    // document.write('<div style="position: absolute; bottom: 5px; background: lightcoral;"><h6 style="margin: 2px 5px;">we are here</h6></div>')
    </script>
    <script>
    function pushMessage () {

      var msg = // { text: 'from our Craft parent' }
        { text: document.getElementById('liveVue').innerText }
      // get reference to window in iframe
      console.log('preparing: ' + msg.text)
      var frame = iframeElem // document.getElementById('ifrm')
      console.log('frame.iframeReady: ' + frame.dataset.iframeReady)
      console.log('sending: ' + msg.text + ', to:' + frame.name)
      var win = frame.contentWindow
      // post msg to win - but remember, otherwise mayn't touch it
      // because CSRF rules as this iframe src is on another site
      win.postMessage(msg, '*')
      iframeElem.className = 'lv-iframe lv-frame-show'
      contentElement.className = 'lv-content-show'
    }

    let tickCount = 0

    function tickDelayPush () {

      if (iframeLoaded === 'loaded') {
        console.log('tickDelayPush got loaded at tick: ' + tickCount)
        pushMessage()
        // setTimeout(pushMessage, 0) // *todo* still need our tick? think not
      } else {
        console.log('ticking: ' + tickCount)
        if (tickCount++ > 50) { // *todo* can go down when settable
          console.log('ticks timed out: no iframe answering')
        } else {
          setTimeout(tickDelayPush, 50) // *todo* should be settable, within limits
        }
      }
    }

    window.addEventListener('load', tickDelayPush, false)

    </script>
</div>

</body>
</html>
