<!DOCTYPE html>
<html lang="en">
{# *todo* lots of console.log in here for dev/beta; convert to configurablelogging  #}
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
    /* n.b. don't believe an IDE that these aren't used -- they are, in javascript. To be fully put there... */
    .lv-iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    .lv-frame-hidden {
        visibility: hidden;
        display: none;
        /*width: 0;*/
    }
    .lv-frame-show {
        visibility: visible;
        display: block;
        /*width: 100%;*/
    }
    .lv-content-hide {
        visibility: hidden;
        display: none;
        opacity: 0;
    }
    .lv-content-show {
        visibility: visible;
        display: block;
    }
    </style>

</head>
<body>
<noscript>
    <strong>We're sorry but Live Vue previews don't work properly without JavaScript
        enabled. Please enable it to continue.</strong>
</noscript>

<div id="lvindexcontent" class="lv-content-hide">

    {% hook "live-vue" %}

    <script>

    let logIndex = false // clean unless desired

    function indexLog (msg) {
      if (logIndex) {
        console.log(msg)
      }
    }

    function lvIndexPageError (msg) {
      var contentDiv = document.getElementById('lvindexcontent')
      contentDiv.style.visibility = 'visible'
      contentDiv.style.display = 'block'
      contentDiv.style.opacity = 1
      document.write(msg)
      throw new Error(msg)
    }

    var lvDiv = document.getElementById('liveVue')
    if (!lvDiv) {
      lvIndexPageError('<h2>Sorry, no Live Vue div to proceed on - check Live Vue Settings</h2>')
    }

    var lvText = lvDiv.innerText
    var lvData = null
    try {
      lvData = JSON.parse(lvText)
    }
    catch (e) {
      lvIndexPageError('<h2>Sorry, Live Vue data parse error: ' + e + ' - check Live Vue Settings</h2>')
    }

    gatsbySiteUrl = null
    gatsbyPage = null
    if (lvData && lvData.lvMeta) {
      gatsbySiteUrl = lvData.lvMeta.liveVueGatsbySiteUrl
      gatsbyPage = lvData.lvMeta.liveVueGatsbyPage
      indexLog('gatsbySiteUrl: ' + gatsbySiteUrl)
      indexLog('gatsbyPage: ' + gatsbyPage)
    }

    var gatsbySite = null

    if (gatsbySiteUrl && gatsbyPage) {
      gatsbySite = gatsbySiteUrl + '/' + gatsbyPage
    } else {
      lvIndexPageError(
        'Sorry, Live Vue error in gatsbySiteUrl: ' +
        gatsbySiteUrl +
        ', or gatsbyPage: ' + gatsbyPage)
    }
    indexLog('gatsbySite: ' + gatsbySite)

    var iframeElem = document.createElement('iframe')
    iframeElem.src = gatsbySite + '?isLiveVue=1'
    iframeElem.id = 'ifrm'
    iframeElem.className = 'lv-iframe lv-frame-hidden'

    // *todo* any amount of these dataset tryouts can go
    iframeElem.name = 'live-vue-frame'
    iframeElem.dataset.iframeReady = 'no'
    iframeElem.dataset.isLiveVue = true

    document.body.appendChild(iframeElem)
    // *todo* out also all with contentElement - nothing touches, hence msgs
    var contentElement = document.getElementById('lvindexcontent')

    // for our postMessage from the iframe
    var iframeLoaded = 'no'
    function receiveMessage(event) {
      indexLog('parent received message: ' + JSON.stringify(event.data))
      if (event.data === 'loaded') {
        iframeLoaded = 'loaded'
        indexLog('parent got iframe loaded on data: ' + event.data)
      }
    }
    window.addEventListener('message', receiveMessage, false)

    function pushMessage () {
      var msg = // { text: 'from our Craft parent' }
        { text: document.getElementById('liveVue').innerText }
      // get reference to window in iframe
      indexLog('preparing: ' + msg.text)
      var frame = iframeElem // document.getElementById('ifrm')
      indexLog('frame.iframeReady: ' + frame.dataset.iframeReady)
      indexLog('sending: ' + msg.text + ', to:' + frame.name)
      var win = frame.contentWindow
      // post msg to win - but remember, otherwise mayn't touch it
      // because CSRF rules as this iframe src is on another site
      win.postMessage(msg, '*')
      iframeElem.className = 'lv-iframe lv-frame-show'
      contentElement.className = 'lv-content-show'
    }

    let tickCount = 0

    function tickDelayPush () {

      if (iframeLoaded === 'loaded') {
        indexLog('tickDelayPush got loaded at tick: ' + tickCount)
        pushMessage()
        // setTimeout(pushMessage, 0) // *todo* still need our tick? think not
      } else {
        indexLog('ticking: ' + tickCount)
        if (tickCount++ > 50) { // *todo* can go down when settable
          indexLog('ticks timed out: no iframe answering')
        } else {
          setTimeout(tickDelayPush, 50) // *todo* should be settable, within limits
        }
      }
    }
    window.addEventListener('load', tickDelayPush, false)

    </script>
</div>

</body>
</html>
