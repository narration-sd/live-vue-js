<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
    .lv-iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    /* these have rules marked out as they don't work */
    .lv-hidden {
        /*visibility: 'hidden';*/
        /*width: 0;*/
    }
    .lv-show {
        /*visibility: 'visible';*/
        /*width: 100%;*/
    }
    .lv-content-hide {
        visibility: hidden;
        opacity: 0;
    }
    .lv-content-show {
        visibility: visible;
    }
    </style>

</head>
<body>
<noscript>
    <strong>We're sorry but Live Vue previews don't work properly without JavaScript
        enabled. Please enable it to continue.</strong>
</noscript>

<div id="content" class="lv-content-hide">
    <script>
    // var gatsbySite = "http://localhost:8001//page-5" // *todo* for now, before Settings routing
    // var gatsbySite = 'https://localhost/page-5' // proxy *todo* for now, before Settings routing
    // var gatsbySite = "https://lv-gatsby.test/page-5" // *todo* for now, before Settings routing
    var gatsbySite = "https://lv-gatsby.test/page-7" // *todo* for now, before Settings routing
    </script>
    {% hook "live-vue" %}
    <script>
    var iframeElem = document.createElement('iframe')
    iframeElem.src = gatsbySite + '?isLiveVue=1'
    iframeElem.id = 'ifrm'
    iframeElem.className = 'lv-iframe lv-hidden'
    iframeElem.name = 'live-vue-frame'
    iframeElem.dataset.iframeReady = 'no'
    iframeElem.dataset.isLiveVue = true
    document.body.appendChild(iframeElem)
    var contentElement = document.getElementById('content')

    // for our postMessage from the iframe
    var iframeLoaded = 'no'
    function receiveMessage(event) {
      console.log('parent received message: ' + JSON.stringify(event.data))
      if (event.data = 'loaded') {
        iframeLoaded = 'loaded'
        // document.getElementById('content').style.visibility = 'visible'
        // document.getElementById('content').style.opacity = 1
        // document.write('DO WE SEE THIS ANYWAY?')
      }
    }
    window.addEventListener('message', receiveMessage, false)
    </script>
    {#<iframe id="ifrm" name="live-vue" class="lv-iframe"#}
    {#        src="https://localhost/page-5"></iframe>#}
    {#<iframe id="ifrm" name="live-vue" class="lv-iframe" src="https://lv-gatsby.test/page-5"></iframe>#}
    {#<iframe id="ifrm" name="live-vue" class="lv-iframe" src="https://localhost/page-5"></iframe>#}
    {#<iframe id="ifrm" name="live-vue" class="lv-iframe" ></iframe>#}
    <script>
    // document.getElementById('ifrm').src = gatsbySite
    // document.write('<div style="position: absolute; bottom: 5px; background: lightcoral;"><h6 style="margin: 2px 5px;">we are here</h6></div>')
    </script>
    <script>
    function pushMessage () {

      var msg = // { text: 'from our Craft parent' }
        { text: document.getElementById('liveVue').innerText }
      // get reference to window in iframe
      console.log('preparing: ' + msg.text)
      var frame = iframeElem // document.getElementById('ifrm')
      console.log('frame.iframeReady: ' + frame.dataset.iframeReady)
      console.log('sending: ' + msg.text + ', to:' + frame.name)
      var win = frame.contentWindow
      // post msg to win - but remember, otherwise mayn't touch it
      // because CSRF rules as this iframe src is on another site
      win.postMessage(msg, '*')
      iframeElem.className = 'lv-iframe lv-show'
      contentElement.className = 'lv-content-show'
    }

    function tickDelayPush () {
      console.log('beginning tick timeout')
      if (iframeLoaded === 'loaded') {
        console.log('tickDelayPush got loaded')
        pushMessage()
        // setTimeout(pushMessage, 0) // still need our tick?
      } else {
        setTimeout(tickDelayPush, 50) // *todo* should be settable?
      }

    }
    window.addEventListener('load', tickDelayPush, false)

    </script>
</div>

</body>
</html>
